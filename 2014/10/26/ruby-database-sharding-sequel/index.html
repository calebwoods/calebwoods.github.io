<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
    <title>Ruby Database Sharding with Sequel</title>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport" />
    <meta content="ruby,oracle,database" name="keywords" />
    <link href="//brick.a.ssl.fastly.net/Noto+Sans:400,400i,700" rel="stylesheet" />
    <link href="/css/syntax.css" rel="stylesheet" />
    <link href="/css/main.css" rel="stylesheet" />
    <link href="/feed.xml" rel="alternate" type="application/atom+xml" />
  </head>
  <body>
    <div class="header">
      <div class="overlay">
        <div class="site">
          <h1 class="title">
            <a href="/">
              <div class="avatar"></div>
              Caleb Woods</a>
          </h1>
          <div class="extra">
            <a href="/feed.xml">feed</a>
            <a href="#contact">contact</a>
          </div>
        </div>
      </div>
    </div>
    <div class="site">

      <span class="back"><a href="/">Home</a> ></span>
<h2>
  Ruby Database Sharding with Sequel
</h2>

<p class="meta">
  26 Oct 2014
  
    <a class="article-tag" href="/tags/ruby">ruby</a>
  
    <a class="article-tag" href="/tags/oracle">oracle</a>
  
    <a class="article-tag" href="/tags/database">database</a>
  
</p>

<div class="post">
  <p>In some of my more recent Ruby projects I&#39;ve had the chance to use the Sequel gem instead of the traditional choice of ActiveRecord and have been very impressed.  On one such project I needed to build a Ruby API over a legacy Oracle database with a custom sharding setup.</p>

<h3>Database Configuration</h3>

<p>The sharding setup for this Oracle database was a central &quot;Main&quot; database that held basic information like user logins and global customer information.  Each customer&#39;s data, however, was stored in one of dozens of customer database shards.</p>

<p>Some of these shards were unique to a customer in order to provide siloing of a customer&#39;s data, and some shards contained multiple smaller customers.  Below is a diagram of the database setup.</p>

<p><img src="/images/sharding.png" alt="Sharding Diagram"></p>

<h3>Sequel vs. ActiveRecord</h3>

<p>My initial strategy was using ActiveRecord to create a new abstract class to connect to each shard.  I then wrote a class to handle creating the proper child classes which would inherit from the proper abstract class based on the <code>customer_id</code> and database table.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">CustomerShardManager</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">shard_class</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
    <span class="no">Class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">base_by_customer_id</span><span class="p">(</span><span class="n">customer_id</span><span class="p">))</span> <span class="k">do</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">post</span> <span class="o">=</span> <span class="no">CustomerShardManager</span><span class="o">.</span><span class="n">shard_class</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;legacy_posts&#39;</span><span class="p">)</span>
<span class="n">post</span><span class="o">.</span><span class="n">all</span>
</code></pre></div>
<p>The <code>post</code> variable in the above example would return a scoped ActiveRecord class in the correct shard for a customer and table combination.</p>

<p>This worked to be able to run general ActiveRecord query methods, but it did not allow for setting specific data relationships or creating custom helper methods for the class.</p>

<p>There are some existing ActiveRecord sharding gems, like <a href="https://github.com/tchandy/octopus">octopus</a>, that I could have used. Octopus, however, does not allow for adding shards dynamically or pulling shard connection information from the &quot;Main&quot; DB instead of a static config file.</p>

<h3>Refactoring with Sequel</h3>

<p>On the other hand, the Sequel gem has a nice set of plugins for handling <a href="http://sequel.jeremyevans.net/rdoc/files/doc/sharding_rdoc.html#label-Sharding">database sharding</a>.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span><span class="p">(</span><span class="no">CUSTOMER_DB</span><span class="o">[</span><span class="ss">:legacy_posts</span><span class="o">]</span><span class="p">)</span>
  <span class="n">one_to_many</span> <span class="ss">:comments</span>

  <span class="k">def</span> <span class="nf">excerpt</span>
    <span class="n">text</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">50</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span><span class="p">(</span><span class="no">CUSTOMER_DB</span><span class="o">[</span><span class="ss">:legacy_comments</span><span class="o">]</span><span class="p">)</span>
  <span class="n">many_to_one</span> <span class="ss">:post</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">CustomerShardManager</span>
  <span class="c1">#...</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">use_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span>
    <span class="no">CUSTOMER_DB</span><span class="o">.</span><span class="n">with_server</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">shard_name</span><span class="p">(</span><span class="n">customer_id</span><span class="p">))</span> <span class="k">do</span>
      <span class="no">CUSTOMER_DB</span><span class="o">.</span><span class="n">synchronize</span> <span class="p">{</span> <span class="k">yield</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">CustomerShardManager</span><span class="o">.</span><span class="n">use_customer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Post</span><span class="o">.</span><span class="n">all</span>
<span class="k">end</span>
</code></pre></div>
<p>This example addresses the concerns with our ActiveRecord spike and provides a simple interface to set the shard connection.</p>

<p>Using the <code>with_server</code> method that Sequel provides, we can create our own method that takes a block and within that block use the correct shard connection for all queries in that block.</p>

<p>We can also use the <a href="http://sequel.jeremyevans.net/rdoc-plugins/files/lib/sequel/extensions/schema_caching_rb.html">schema_caching</a> plugin to ensure Sequel only needs to do one describe of the database tables for each shard.</p>

<h3>Other Benefits of Sequel</h3>

<ul>
<li><a href="http://sequel.jeremyevans.net/documentation.html">Extensive documentation</a> with great examples of Sequel</li>
<li>Multiple layers of abstraction for querying by using <a href="http://sequel.jeremyevans.net/rdoc/files/doc/dataset_basics_rdoc.html">Datasets</a> and <a href="http://sequel.jeremyevans.net/rdoc/files/doc/object_model_rdoc.html#label-Sequel%3A%3AModel">Models</a></li>
<li>[Conversion guide for ActiveRecord]((http://sequel.jeremyevans.net/rdoc/files/doc/active<em>record</em>rdoc.html)</li>
</ul>

<h3>Choosing Sequel over ActiveRecord</h3>

<p>Based on my experience with Sequel so far I&#39;ve come up with some heuristics for the types of projects on which I would consider using Sequel instead of ActiveRecord.</p>

<ul>
<li>Building on a legacy database</li>
<li>Using a database other than the Rails standard of PostreSQL or Mysql</li>
<li>Using PosgreSQL with native datatypes</li>
<li>Building small web app or API outside of Rails</li>
</ul>

<p>Would love to hear your thoughts on other types of projects that Sequel is a good fit for. See my contact info in the footer.</p>

</div>

<div class="related-posts">
  <h4>Related Posts</h4>

  <ul>
    
      <li>
        <a href="/2014/10/07/oracle-connection-hanging-ruby/">
          <span class="article-title">Oracle connection hanging in Ruby</span>
        </a>
      </li>
    
      <li>
        <a href="/2014/12/23/fix-partial-rails-migration/">
          <span class="article-title">Fix Partial Rails Migration</span>
        </a>
      </li>
    
      <li>
        <a href="/2014/04/03/static-lists/">
          <span class="article-title">Static Lists: Database Table, Module, or Enums</span>
        </a>
      </li>
    
  </ul>
</div>


      <div class="footer" id="contact">
        <p>
          &copy; 2013 - 2019 Caleb Woods. All Right Reserved.
        </p>
        <div class="contact">
          <p>
            <span>Caleb Woods</span><span>Software Craftsman</span><span>caleb@calebwoods.com</span>
          </p>
        </div>
        <div class="contact">
          <p>
            <a href="https://github.com/calebwoods">github.com/calebwoods</a>
            <a href="https://medium.com/@calebwoods">medium.com/@calebwoods</a>
            <a href="https://twitter.com/calebwoods">twitter.com/calebwoods</a>
            <a href="https://www.linkedin.com/in/calebwoods">linkedin.com/in/calebwoods</a>
          </p>
        </div>
      </div>
    </div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', 'UA-49249459-1', 'calebwoods.com');ga('send', 'pageview');
    </script>
  </body>
</html>
