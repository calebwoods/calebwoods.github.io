<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
    <title>Angular.js, IE9, CORS, and Nginx</title>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport" />
    <meta content="ie,angularjs,nginx,security,server" name="keywords" />
    <link href="//brick.a.ssl.fastly.net/Noto+Sans:400,400i,700" rel="stylesheet" />
    <link href="/css/syntax.css" rel="stylesheet" />
    <link href="/css/main.css" rel="stylesheet" />
    <link href="/feed.xml" rel="alternate" type="application/atom+xml" />
  </head>
  <body>
    <div class="header">
      <div class="overlay">
        <div class="site">
          <h1 class="title">
            <a href="/">
              <div class="avatar"></div>
              Caleb Woods</a>
          </h1>
          <div class="extra">
            <a href="/feed.xml">feed</a>
            <a href="#contact">contact</a>
          </div>
        </div>
      </div>
    </div>
    <div class="site">

      <span class="back"><a href="/">Home</a> ></span>
<h2>
  Angular.js, IE9, CORS, and Nginx
</h2>

<p class="meta">
  10 May 2014
  
    <a class="article-tag" href="/tags/ie">ie</a>
  
    <a class="article-tag" href="/tags/angularjs">angularjs</a>
  
    <a class="article-tag" href="/tags/nginx">nginx</a>
  
    <a class="article-tag" href="/tags/security">security</a>
  
    <a class="article-tag" href="/tags/server">server</a>
  
</p>

<div class="post">
  <p>In this post I&#39;ll share an example of a recent Angular.js application I worked on which needed to support Internet Explorer 9 and connect to multiple remote APIs.</p>

<p>The issue with this setup is that by default the browser prevents any Javascript on the page from making requests to another domain. This is done to prevent <a href="http://en.wikipedia.org/wiki/Cross-site_scripting">Cross Site Scripting</a>. While this is a good safety measure, as application developers it can be common to have a backend API hosted on a subdomain such as <code>api.example.com</code> and have the frontend Javascript application hosted on separate domain like <code>frontend.example.com</code> which cause an issue of how to connect to the API.</p>

<h3>JSONP</h3>

<p><a href="http://en.wikipedia.org/wiki/JSONP">JSONP</a> is an option that many popular APIs expose for Javascript clients. With JSONP, the server will respond with a Javascript body which includes a function callback as specified in the request. We should note that JSONP only supports GET requests and uses <code>&lt;script&gt;</code> tags to get around the Cross Site Scripting issue.</p>

<p>This works pretty well with APIs that serve Javascript clients, but unfortunately it means you will have a different API format for mobile clients of the API.</p>

<h3>Cross Origin Request Sharing</h3>

<p>Thankfully there is a solution for modern browsers called <a href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing">Cross Origin Request Sharing</a>, or CORS for short. CORS allows Javascript applications to make requests to a server that return the proper CORS headers.</p>

<p>As it is, though, Internet Explorer 9 and below do not support CORS, which is a problem for our example.</p>

<h3>Proxies</h3>

<p>A server side proxy for our API, however, does allow us to solve this issue. With a proxy we can let the server forward requests to the other subdomains, and to the browser it looks like it is calling the same server.</p>

<p>This means we could have a mapping of request like below which works in all browsers.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">frontend.example.com/api/items =&gt; api.example.com/items
</code></pre></div>
<h3>Development</h3>

<p>In development, setting up your proxy is pretty simple using <a href="https://github.com/drewzboto/grunt-connect-proxy">grunt-connect-proxy</a>. You will just need to add proxy section to your <code>Gruntfile.js</code>, similar to the example below.</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">connect</span><span class="o">:</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="nx">server</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">proxies</span><span class="o">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nx">context</span><span class="o">:</span> <span class="s1">&#39;/api1&#39;</span><span class="p">,</span>
                <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
                <span class="nx">port</span><span class="o">:</span> <span class="mi">4000</span><span class="p">,</span>
                <span class="nx">https</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">changeOrigin</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">rewrite</span><span class="o">:</span> <span class="p">{</span>
                    <span class="s1">&#39;^/api1&#39;</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nx">context</span><span class="o">:</span> <span class="s1">&#39;/api2&#39;</span><span class="p">,</span>
                <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
                <span class="nx">port</span><span class="o">:</span> <span class="mi">4100</span><span class="p">,</span>
                <span class="nx">https</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">changeOrigin</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">rewrite</span><span class="o">:</span> <span class="p">{</span>
                    <span class="s1">&#39;^/api2&#39;</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>For more information on options with <a href="https://github.com/drewzboto/grunt-connect-proxy">grunt-connect-proxy</a>, check out <a href="http://fettblog.eu/blog/2013/09/20/using-grunt-connect-proxy/">this</a> blog post.</p>

<h3>Production</h3>

<p>We deployed our Angular application with Nginx as a web server to serve static files. In addition to static files, Nginx has great support to proxy to other web servers.  For our APIs we just need to add some location directives to the <code>nginx.conf</code> file like the example below.</p>
<div class="highlight"><pre><code class="language-nginx" data-lang="nginx"><span class="k">location</span> <span class="s">/api1</span> <span class="p">{</span>
  <span class="kn">rewrite</span> <span class="s">^/api1/(.*)</span> <span class="s">/</span><span class="nv">$1</span> <span class="s">break</span><span class="p">;</span>
  <span class="kn">proxy_redirect</span> <span class="no">off</span><span class="p">;</span>
  <span class="kn">proxy_pass</span> <span class="s">https://api1.example.com</span><span class="p">;</span>
  <span class="c1"># ...</span>
<span class="p">}</span>

<span class="k">location</span> <span class="s">/api2</span> <span class="p">{</span>
  <span class="kn">rewrite</span> <span class="s">^/api2/(.*)</span> <span class="s">/</span><span class="nv">$1</span> <span class="s">break</span><span class="p">;</span>
  <span class="kn">proxy_redirect</span> <span class="no">off</span><span class="p">;</span>
  <span class="kn">proxy_pass</span> <span class="s">https://api2.example.com</span><span class="p">;</span>
  <span class="c1"># ...</span>
<span class="p">}</span>
</code></pre></div>
<p>To see a full example of the Nginx config, take a look at <a href="https://gist.github.com/calebwoods/5e88b5e323d55ad71195">this gist</a>.</p>

<h3>Take Aways</h3>

<p>Decide on which browsers to support early on in your project. Also make sure that you are running tests frequently in development and production with the browsers you will support.</p>

<p>If on the Mac and developing to support Internet Explorer, I highly recomend checking out Microsofts collection of prebuilt <a href="http://www.modern.ie/en-us/virtualization-tools">Virtual Machine images</a> to use in testing.</p>

</div>

<div class="related-posts">
  <h4>Related Posts</h4>

  <ul>
    
      <li>
        <a href="/2014/08/26/owasp-password-hashing-ruby/">
          <span class="article-title">OWASP Password Hashing in Ruby</span>
        </a>
      </li>
    
      <li>
        <a href="/2015/10/19/choosing-frontend-form-data-heavy-applications/">
          <span class="article-title">Choosing a Frontend for Form and Data Heavy Applications</span>
        </a>
      </li>
    
      <li>
        <a href="/2015/06/27/mixing-ansible-roles-tasks/">
          <span class="article-title">Mixing Ansible Roles and Tasks</span>
        </a>
      </li>
    
  </ul>
</div>


      <div class="footer" id="contact">
        <p>
          &copy; 2013 - 2019 Caleb Woods. All Right Reserved.
        </p>
        <div class="contact">
          <p>
            <span>Caleb Woods</span><span>Software Craftsman</span><span>caleb@calebwoods.com</span>
          </p>
        </div>
        <div class="contact">
          <p>
            <a href="https://github.com/calebwoods">github.com/calebwoods</a>
            <a href="https://medium.com/@calebwoods">medium.com/@calebwoods</a>
            <a href="https://twitter.com/calebwoods">twitter.com/calebwoods</a>
            <a href="https://www.linkedin.com/in/calebwoods">linkedin.com/in/calebwoods</a>
          </p>
        </div>
      </div>
    </div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', 'UA-49249459-1', 'calebwoods.com');ga('send', 'pageview');
    </script>
  </body>
</html>
